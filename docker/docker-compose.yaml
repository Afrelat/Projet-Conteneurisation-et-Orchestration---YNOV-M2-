version: '3.8'

services:
  web:
    build:
      context: ../
      dockerfile: docker/web/Dockerfile
    image: m2cloud/web:latest
    ports:
      - "8080:80"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - APPLICANTS_API_URL=http://applicants-api:80
      - JOBS_API_URL=http://jobs-api:80
      - IDENTITY_API_URL=http://identity-api:80
    depends_on:
      - applicants-api
      - jobs-api
      - identity-api
    networks:
      - m2cloud-network

  applicants-api:
    build:
      context: ../
      dockerfile: docker/applicants-api/Dockerfile
    image: m2cloud/applicants-api:latest
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ConnectionStrings__DefaultConnection=Server=sql-data;Database=M2CloudDB;User Id=sa;Password=YourStrong@Passw0rd;TrustServerCertificate=True
      - RABBITMQ_HOST=rabbitmq
    depends_on:
      - sql-data
      - rabbitmq
    networks:
      - m2cloud-network

  jobs-api:
    build:
      context: ../
      dockerfile: docker/jobs-api/Dockerfile
    image: m2cloud/jobs-api:latest
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ConnectionStrings__DefaultConnection=Server=sql-data;Database=M2CloudDB;User Id=sa;Password=YourStrong@Passw0rd;TrustServerCertificate=True
      - RABBITMQ_HOST=rabbitmq
    depends_on:
      - sql-data
      - rabbitmq
    networks:
      - m2cloud-network

  identity-api:
    build:
      context: ../
      dockerfile: docker/identity-api/Dockerfile
    image: m2cloud/identity-api:latest
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ConnectionStrings__DefaultConnection=Server=sql-data;Database=M2CloudDB;User Id=sa;Password=YourStrong@Passw0rd;TrustServerCertificate=True
      - JWT_SECRET=your-super-secret-jwt-key-here-min-32-chars
    depends_on:
      - sql-data
    networks:
      - m2cloud-network

  sql-data:
    image: mcr.microsoft.com/mssql/server:2022-latest
    environment:
      - ACCEPT_EULA=Y
      - MSSQL_SA_PASSWORD=YourStrong@Passw0rd
    ports:
      - "1433:1433"
    volumes:
      - sql-data-volume:/var/opt/mssql
    networks:
      - m2cloud-network

  rabbitmq:
    image: rabbitmq:3-management
    environment:
      - RABBITMQ_DEFAULT_USER=guest
      - RABBITMQ_DEFAULT_PASS=guest
    ports:
      - "5672:5672"
      - "15672:15672"
    networks:
      - m2cloud-network

networks:
  m2cloud-network:
    driver: bridge

volumes:
  sql-data-volume:
